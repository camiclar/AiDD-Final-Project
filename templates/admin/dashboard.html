{% extends "base.html" %}

{% block title %}Admin Dashboard - Campus Resource Hub{% endblock %}

{% block content %}
<div class="mb-4">
    <h1 class="mb-2">Admin Panel</h1>
    <p class="text-muted">Manage users, resources, and bookings</p>
</div>

<!-- Stats Grid -->
<div class="row g-4 mb-4">
    <div class="col-md-6 col-lg-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1 small">Total Users</p>
                        <h3 class="mb-0">{{ stats.total_users }}</h3>
                    </div>
                    <i class="bi bi-people text-primary" style="font-size: 2.5rem;"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-lg-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1 small">Active Resources</p>
                        <h3 class="mb-0">{{ stats.active_resources }}</h3>
                    </div>
                    <i class="bi bi-book text-success" style="font-size: 2.5rem;"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-lg-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1 small">Pending Approvals</p>
                        <h3 class="mb-0">{{ stats.pending_approvals }}</h3>
                    </div>
                    <i class="bi bi-shield-check text-warning" style="font-size: 2.5rem;"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-lg-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1 small">Total Bookings</p>
                        <h3 class="mb-0">{{ stats.total_bookings }}</h3>
                    </div>
                    <i class="bi bi-graph-up text-info" style="font-size: 2.5rem;"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <a class="nav-link {% if active_tab == 'overview' %}active{% endif %}" href="{{ url_for('admin.dashboard') }}">
            Overview
        </a>
    </li>
    <li class="nav-item" role="presentation">
        <a class="nav-link {% if active_tab == 'users' %}active{% endif %}" href="{{ url_for('admin.users') }}">
            Users
        </a>
    </li>
    <li class="nav-item" role="presentation">
        <a class="nav-link {% if active_tab == 'resources' %}active{% endif %}" href="{{ url_for('admin.resources') }}">
            Resources
        </a>
    </li>
    <li class="nav-item" role="presentation">
        <a class="nav-link {% if active_tab == 'approvals' %}active{% endif %}" href="{{ url_for('admin.approvals') }}">
            Approvals <span class="badge bg-warning text-dark">{{ stats.pending_approvals }}</span>
        </a>
    </li>
    <li class="nav-item" role="presentation">
        <a class="nav-link {% if active_tab == 'reviews' %}active{% endif %}" href="{{ url_for('admin.reviews') }}">
            Reviews
        </a>
    </li>
</ul>

<div class="tab-content" id="adminTabsContent">
    <!-- Overview Tab -->
    {% if active_tab == 'overview' %}
    <div class="tab-pane fade show active" id="overview" role="tabpanel">
        <div class="row g-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Resources by Category</h5>
                    </div>
                    <div class="card-body">
                        {% if category_data %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Count</th>
                                        <th>Percentage</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% set total = category_data|sum(attribute='count') %}
                                    {% for item in category_data %}
                                    <tr>
                                        <td>{{ item.name }}</td>
                                        <td>{{ item.count }}</td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar" role="progressbar" style="width: {{ (item.count / total * 100) if total > 0 else 0 }}%">
                                                    {{ "%.1f"|format((item.count / total * 100) if total > 0 else 0) }}%
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted">No resources yet.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Recent Activity</h5>
                    </div>
                    <div class="card-body">
                        {% if recent_bookings %}
                        <div class="list-group list-group-flush">
                            {% for booking in recent_bookings %}
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <strong>{{ booking.user.name }}</strong>
                                        <p class="mb-0 small text-muted">Booked {{ booking.resource.title }}</p>
                                        <small class="text-muted">{{ booking.created_at.strftime('%B %d, %Y at %I:%M %p') }}</small>
                                    </div>
                                    <span class="badge bg-{{ 'success' if booking.status == 'approved' else 'warning' if booking.status == 'pending' else 'secondary' }}">
                                        {{ booking.status|title }}
                                    </span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted">No recent activity.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Top Resources</h5>
                    </div>
                    <div class="card-body">
                        {% if top_resources %}
                        <div class="list-group list-group-flush">
                            {% for resource_id, title, booking_count in top_resources %}
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-truncate me-2">{{ title }}</span>
                                    <span class="badge bg-primary">{{ booking_count }} bookings</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted">No bookings yet.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Users Tab -->
    {% if active_tab == 'users' %}
    <div class="tab-pane fade show active" id="users" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">User Management</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Department</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if users %}
                            {% for user in users %}
                            <tr>
                                <td>{{ user.name }}</td>
                                <td>{{ user.email }}</td>
                                <td>
                                    <form method="POST" action="{{ url_for('admin.update_user_role', user_id=user.id) }}" class="d-inline">
                                        <select name="role" class="form-select form-select-sm d-inline-block" style="width: auto;" onchange="this.form.submit()">
                                            <option value="student" {% if user.role == 'student' %}selected{% endif %}>Student</option>
                                            <option value="staff" {% if user.role == 'staff' %}selected{% endif %}>Staff</option>
                                            <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>Admin</option>
                                        </select>
                                    </form>
                                </td>
                                <td>{{ user.department or 'N/A' }}</td>
                                <td>{{ user.created_at.strftime('%B %d, %Y') }}</td>
                                <td>
                                    {% if user.id != current_user.id %}
                                    <form method="POST" action="{{ url_for('admin.delete_user', user_id=user.id) }}" 
                                          class="d-inline" onsubmit="return confirm('Are you sure you want to delete {{ user.name }}? This action cannot be undone.');">
                                        <button type="submit" class="btn btn-sm btn-danger">
                                            <i class="bi bi-trash"></i> Delete
                                        </button>
                                    </form>
                                    {% else %}
                                    <span class="text-muted small">Current user</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="6" class="text-center text-muted">No users found.</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Resources Tab -->
    {% if active_tab == 'resources' %}
    <div class="tab-pane fade show active" id="resources" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Resource Management</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Category</th>
                                <th>Owner</th>
                                <th>Status</th>
                                <th>Rating</th>
                                <th>Bookings</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if resources %}
                            {% for item in resources %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('resources.detail', resource_id=item.resource.id) }}">
                                        {{ item.resource.title }}
                                    </a>
                                </td>
                                <td>{{ item.resource.category|replace('-', ' ')|title }}</td>
                                <td>{{ item.resource.owner.name }}</td>
                                <td>
                                    <span class="badge bg-{{ 'success' if item.resource.status == 'published' else 'warning' if item.resource.status == 'draft' else 'secondary' }}">
                                        {{ item.resource.status|title }}
                                    </span>
                                </td>
                                <td>
                                    {% if item.rating > 0 %}
                                    <i class="bi bi-star-fill text-warning"></i> {{ item.rating }} ({{ item.review_count }})
                                    {% else %}
                                    <span class="text-muted">No reviews</span>
                                    {% endif %}
                                </td>
                                <td>{{ item.booking_count }}</td>
                                <td>
                                    {% if item.resource.status == 'published' %}
                                    <form method="POST" action="{{ url_for('admin.archive_resource', resource_id=item.resource.id) }}" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-warning">
                                            <i class="bi bi-archive"></i> Archive
                                        </button>
                                    </form>
                                    {% elif item.resource.status == 'archived' %}
                                    <form method="POST" action="{{ url_for('admin.publish_resource', resource_id=item.resource.id) }}" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-success">
                                            <i class="bi bi-check-circle"></i> Publish
                                        </button>
                                    </form>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="7" class="text-center text-muted">No resources found.</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Approvals Tab -->
    {% if active_tab == 'approvals' %}
    <div class="tab-pane fade show active" id="approvals" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Pending Booking Approvals</h5>
            </div>
            <div class="card-body">
                {% if pending_bookings %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Resource</th>
                                <th>Requester</th>
                                <th>Date & Time</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for booking in pending_bookings %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('resources.detail', resource_id=booking.resource_id) }}">
                                        {{ booking.resource.title }}
                                    </a>
                                </td>
                                <td>{{ booking.user.name }}</td>
                                <td>
                                    <div>
                                        <strong>{{ booking.start_time.strftime('%B %d, %Y') }}</strong><br>
                                        <small class="text-muted">
                                            {{ booking.start_time.strftime('%I:%M %p') }} - {{ booking.end_time.strftime('%I:%M %p') }}
                                        </small>
                                    </div>
                                </td>
                                <td>
                                    <p class="mb-0 small">{{ booking.notes or 'No notes' }}</p>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <form method="POST" action="{{ url_for('admin.approve_booking', booking_id=booking.id) }}" class="d-inline">
                                            <button type="submit" class="btn btn-sm btn-success">
                                                <i class="bi bi-check-circle"></i> Approve
                                            </button>
                                        </form>
                                        <form method="POST" action="{{ url_for('admin.reject_booking', booking_id=booking.id) }}" class="d-inline">
                                            <button type="submit" class="btn btn-sm btn-danger">
                                                <i class="bi bi-x-circle"></i> Reject
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-3">No pending approvals</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Reviews Tab -->
    {% if active_tab == 'reviews' %}
    <div class="tab-pane fade show active" id="reviews" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Review Moderation</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Resource</th>
                                <th>User</th>
                                <th>Rating</th>
                                <th>Comment</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if reviews %}
                            {% for review in reviews %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('resources.detail', resource_id=review.resource_id) }}">
                                        {{ review.resource.title }}
                                    </a>
                                </td>
                                <td>{{ review.user.name }}</td>
                                <td>
                                    {% for i in range(1, 6) %}
                                    <i class="bi bi-star{{ '-fill' if i <= review.rating else '' }} text-warning"></i>
                                    {% endfor %}
                                    <span class="ms-1">{{ review.rating }}/5</span>
                                </td>
                                <td>
                                    <p class="mb-0 small" style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                        {{ review.comment }}
                                    </p>
                                </td>
                                <td>{{ review.created_at.strftime('%B %d, %Y') }}</td>
                                <td>
                                    <form method="POST" action="{{ url_for('reviews.delete', review_id=review.id) }}" 
                                          class="d-inline" onsubmit="return confirm('Are you sure you want to delete this review?');">
                                        <button type="submit" class="btn btn-sm btn-danger">
                                            <i class="bi bi-trash"></i> Delete
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="6" class="text-center text-muted">No reviews found.</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- AI Chatbot - Floating Widget -->
<div id="chatbotWidget" class="chatbot-widget">
    <!-- Chat Window -->
    <div id="chatbotWindow" class="chatbot-window" style="display: none;">
        <div class="chatbot-header">
            <div class="d-flex align-items-center">
                <i class="bi bi-robot me-2"></i>
                <div>
                    <h6 class="mb-0">Admin Assistant</h6>
                    <small class="text-muted">Always here to help</small>
                </div>
            </div>
            <div class="chatbot-header-actions">
                <button type="button" class="btn btn-sm btn-link text-white p-1" id="chatbotMinimize" title="Minimize">
                    <i class="bi bi-dash-lg"></i>
                </button>
                <button type="button" class="btn btn-sm btn-link text-white p-1" id="chatbotClose" title="Close">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        </div>
        <div class="chatbot-body">
            <div id="chatbotMessages" class="chatbot-messages">
                <div class="text-muted text-center py-3">
                    <i class="bi bi-chat-dots"></i> Ask a question to get started...
                </div>
            </div>
            <div id="chatbotError" class="alert alert-danger m-2" style="display: none;"></div>
        </div>
        <div class="chatbot-footer">
            <div class="input-group">
                <input type="text" class="form-control" id="chatbotInput" placeholder="Ask me anything..." aria-label="Chatbot question">
                <button class="btn btn-primary" type="button" id="chatbotSubmit">
                    <i class="bi bi-send"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Floating Button -->
    <button id="chatbotToggle" class="chatbot-toggle-btn" type="button" title="Open Admin Assistant">
        <i class="bi bi-robot"></i>
    </button>
</div>

<style>
    /* Floating Chatbot Widget */
    .chatbot-widget {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1050;
    }
    
    /* Floating Toggle Button */
    .chatbot-toggle-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .chatbot-toggle-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }
    
    .chatbot-toggle-btn:active {
        transform: scale(0.95);
    }
    
    /* Chat Window */
    .chatbot-window {
        position: absolute;
        bottom: 80px;
        right: 0;
        width: 380px;
        height: 500px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        animation: slideUp 0.3s ease;
    }
    
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .chatbot-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .chatbot-header h6 {
        color: white;
        font-weight: 600;
    }
    
    .chatbot-header-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .chatbot-header-actions .btn-link {
        color: white;
        text-decoration: none;
        opacity: 0.8;
        transition: opacity 0.2s;
    }
    
    .chatbot-header-actions .btn-link:hover {
        opacity: 1;
    }
    
    .chatbot-body {
        flex: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        background: #f8f9fa;
    }
    
    .chatbot-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .chatbot-footer {
        padding: 1rem;
        background: white;
        border-top: 1px solid #dee2e6;
    }
    
    /* Message Styles */
    .chatbot-message {
        padding: 0.75rem;
        border-radius: 0.5rem;
        max-width: 85%;
        word-wrap: break-word;
    }
    
    .chatbot-message.user {
        background: #e7f3ff;
        border-left: 3px solid #0d6efd;
        align-self: flex-end;
        margin-left: auto;
    }
    
    .chatbot-message.assistant {
        background: white;
        border-left: 3px solid #6c757d;
        align-self: flex-start;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .chatbot-message .message-header {
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 0.75rem;
        text-transform: uppercase;
        opacity: 0.7;
    }
    
    .chatbot-message .message-content {
        line-height: 1.6;
        font-size: 0.9rem;
    }
    
    .chatbot-message .message-content p {
        margin-bottom: 0.5rem;
    }
    
    .chatbot-message .message-content p:last-child {
        margin-bottom: 0;
    }
    
    .chatbot-message .sql-query {
        margin-top: 0.75rem;
        padding: 0.75rem;
        background: #2d2d2d;
        color: #f8f8f2;
        border-radius: 0.375rem;
        font-family: 'Courier New', monospace;
        font-size: 0.8rem;
        overflow-x: auto;
    }
    
    .chatbot-message .sql-query code {
        color: #f8f8f2;
        background: transparent;
        padding: 0;
    }
    
    .chatbot-message .sql-query small {
        color: #aaa;
        display: block;
        margin-bottom: 0.5rem;
    }
    
    /* Responsive */
    @media (max-width: 576px) {
        .chatbot-window {
            width: calc(100vw - 40px);
            right: 20px;
            left: 20px;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatbotWidget = document.getElementById('chatbotWidget');
    const chatbotWindow = document.getElementById('chatbotWindow');
    const chatbotToggle = document.getElementById('chatbotToggle');
    const chatbotMinimize = document.getElementById('chatbotMinimize');
    const chatbotClose = document.getElementById('chatbotClose');
    const chatbotInput = document.getElementById('chatbotInput');
    const chatbotSubmit = document.getElementById('chatbotSubmit');
    const chatbotMessages = document.getElementById('chatbotMessages');
    const chatbotError = document.getElementById('chatbotError');
    
    let isOpen = false;
    
    // Toggle chatbot window
    function openChatbot() {
        chatbotWindow.style.display = 'flex';
        chatbotToggle.style.display = 'none';
        isOpen = true;
        chatbotInput.focus();
    }
    
    function closeChatbot() {
        chatbotWindow.style.display = 'none';
        chatbotToggle.style.display = 'flex';
        isOpen = false;
    }
    
    function minimizeChatbot() {
        closeChatbot();
    }
    
    // Event listeners for toggle buttons
    chatbotToggle.addEventListener('click', openChatbot);
    chatbotMinimize.addEventListener('click', minimizeChatbot);
    chatbotClose.addEventListener('click', closeChatbot);
    
    // Auto-scroll to bottom of messages
    function scrollToBottom() {
        chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
    }
    
    // Add message to chat
    function addMessage(role, content, sql = null) {
        // Clear "get started" message if present
        const placeholder = chatbotMessages.querySelector('.text-muted.text-center');
        if (placeholder) {
            chatbotMessages.innerHTML = '';
        }
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `chatbot-message ${role}`;
        
        const header = document.createElement('div');
        header.className = 'message-header';
        header.textContent = role === 'user' ? 'You' : 'AI Assistant';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        if (role === 'assistant') {
            contentDiv.innerHTML = content;
        } else {
            contentDiv.textContent = content;
        }
        
        messageDiv.appendChild(header);
        messageDiv.appendChild(contentDiv);
        
        if (sql && role === 'assistant') {
            const sqlDiv = document.createElement('div');
            sqlDiv.className = 'sql-query';
            sqlDiv.innerHTML = '<small>SQL Query:</small><br><code>' + escapeHtml(sql) + '</code>';
            messageDiv.appendChild(sqlDiv);
        }
        
        chatbotMessages.appendChild(messageDiv);
        scrollToBottom();
    }
    
    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Handle submit
    function handleSubmit() {
        const question = chatbotInput.value.trim();
        if (!question) return;
        
        // Open chatbot if closed
        if (!isOpen) {
            openChatbot();
        }
        
        // Hide error
        chatbotError.style.display = 'none';
        
        // Add user message
        addMessage('user', question);
        
        // Clear input
        chatbotInput.value = '';
        
        // Disable input and button
        chatbotInput.disabled = true;
        chatbotSubmit.disabled = true;
        chatbotSubmit.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
        
        // Make API request
        fetch('{{ url_for("admin.chatbot_query") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ question: question })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                let errorMsg = data.error;
                if (data.sql) {
                    errorMsg += '\n\nGenerated SQL:\n' + data.sql;
                }
                chatbotError.textContent = errorMsg;
                chatbotError.style.display = 'block';
                chatbotError.style.whiteSpace = 'pre-wrap';
            } else {
                addMessage('assistant', data.answer, data.sql);
            }
        })
        .catch(error => {
            chatbotError.textContent = 'An error occurred: ' + error.message;
            chatbotError.style.display = 'block';
        })
        .finally(() => {
            // Re-enable input and button
            chatbotInput.disabled = false;
            chatbotSubmit.disabled = false;
            chatbotSubmit.innerHTML = '<i class="bi bi-send"></i>';
            chatbotInput.focus();
        });
    }
    
    // Event listeners
    chatbotSubmit.addEventListener('click', handleSubmit);
    chatbotInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            handleSubmit();
        }
    });
});
</script>
{% endblock %}
